var daysRef=["Sun","Mon","Tues","Weds","Thurs","Fri","Sat"],circleWidth=10,kelvin_to_f=function(t){return(1.8*(t-273.15)+32).toFixed(2)},unixCode_to_weekDay=function(t){return daysRef[new Date(1e3*t).getDay()]},formatChart=function(t){d3.json("http://api.openweathermap.org/data/2.5/forecast/daily?q="+t,function(t){var e,n=[],a=[],r=[],o=[];if(t&&"404"!==t.cod){e=t.list.length,t.list.forEach(function(t,o){var i=kelvin_to_f(t.temp.day),l=unixCode_to_weekDay(t.dt),s={temp:i};n.push(i),a.push(l),o!==e-1&&(s.target=o+1),r.push(s)}),r.forEach(function(t){t.hasOwnProperty("target")&&o.push({source:t,target:r[t.target]})});var i,l={top:30,right:30,bottom:40,left:50},s=400-l.top-l.bottom,c=600-l.left-l.right,d=d3.scale.linear().domain([0,.33*n.length,.66*n.length,n.length]).range(["#B58929","#C61C6F","#268BD2","#85992C"]),u=d3.scale.linear().domain([d3.min(n)-5,d3.max(n)+5]).range([0,s]),f=d3.scale.ordinal().domain(d3.range(0,n.length)).rangeBands([0,c],.2),p=d3.select("body").append("div").attr("id","tool-tip"),y=d3.select("#chart").append("svg").style("background","#E7E0CB").attr("width",c+l.left+l.right).attr("height",s+l.top+l.bottom).append("g").attr("transform","translate("+l.left+", "+l.top+")"),g=d3.scale.linear().domain([d3.min(n)-5,d3.max(n)+5]).range([s,0]),h=d3.scale.ordinal().domain(a).rangeBands([0,c],.2),m=d3.svg.axis().scale(g).orient("left").ticks(10),x=d3.svg.axis().scale(h).orient("bottom").tickValues(h.domain()),v=d3.select("svg").append("g"),k=d3.select("svg").append("g");r.forEach(function(t,e){t.x=f(e)+f.rangeBand()/2,t.y=s-u(t.temp)});y.selectAll("line").data(o).enter().append("line").attr("stroke",function(t,e){return d(e)}).attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.source.x}).attr("y2",function(t){return t.source.y}).transition().attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}).delay(function(t,e){return 200*e}).ease("linear"),y.selectAll("circle").data(r).enter().append("circle").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("fill",function(t,e){return d(e)}).on("mouseover",function(t){p.transition().style("opacity",.9),p.html(t.temp+"&deg;F").style("left",d3.event.pageX-35+"px").style("top",d3.event.pageY-35+"px"),i=this.style.fill,d3.select(this).transition().style("opacity",.5).style("fill","yellow")}).on("mouseout",function(t){d3.select(this).transition().style("opacity",1).style("fill",i),p.transition().style("opacity",0)}).transition().attr("r",circleWidth).delay(function(t,e){return 200*e}).ease("elastic");x(k),k.attr("transform","translate("+l.left+", "+(s+l.top)+")"),k.selectAll("path").style({fill:"none",stroke:"#000"}),k.selectAll("line").style({stroke:"#000"}),m(v),v.attr("transform","translate("+l.left+", "+l.top+")"),v.selectAll("path").style({fill:"none",stroke:"#000"}),v.selectAll("line").style({stroke:"#000"})}})};document.getElementById("city-input").addEventListener("input",function(t){document.getElementById("chart").innerHTML="",formatChart(this.value)});