var daysRef=["Sun","Mon","Tues","Weds","Thurs","Fri","Sat"],circleWidth=10,kelvin_to_f=function(t){return(1.8*(t-273.15)+32).toFixed(2)},unixCode_to_weekDay=function(t){return daysRef[new Date(1e3*t).getDay()]},formatChart=function(t){d3.json("http://api.openweathermap.org/data/2.5/forecast/daily?q="+t,function(t){var e,n=[],a=[],r=[],l=[];if(t&&"404"!==t.cod){e=t.list.length,t.list.forEach(function(t,l){var o=kelvin_to_f(t.temp.day),i=unixCode_to_weekDay(t.dt),s={temp:o};n.push(o),a.push(i),l!==e-1&&(s.target=l+1),r.push(s)}),r.forEach(function(t){t.hasOwnProperty("target")&&l.push({source:t,target:r[t.target]})});var o,i={top:30,right:30,bottom:40,left:50},s=400-i.top-i.bottom,c=600-i.left-i.right,d=d3.scale.linear().domain([0,.33*n.length,.66*n.length,n.length]).range(["#B58929","#C61C6F","#268BD2","#85992C"]),u=d3.scale.linear().domain([d3.min(n)-5,d3.max(n)+5]).range([0,s]),p=d3.scale.ordinal().domain(d3.range(0,n.length)).rangeBands([0,c],.2),f=d3.select("body").append("div").attr("id","tooltip").style("position","absolute").style("padding","0 10px").style("background","white").style("opacity",0),y=d3.select("#chart").append("svg").style("background","#E7E0CB").attr("width",c+i.left+i.right).attr("height",s+i.top+i.bottom).append("g").attr("transform","translate("+i.left+", "+i.top+")"),g=d3.scale.linear().domain([d3.min(n)-5,d3.max(n)+5]).range([s,0]),h=d3.scale.ordinal().domain(a).rangeBands([0,c],.2),m=d3.svg.axis().scale(g).orient("left").ticks(10),v=d3.svg.axis().scale(h).orient("bottom").tickValues(h.domain()),x=d3.select("svg").append("g"),k=d3.select("svg").append("g");r.forEach(function(t,e){t.x=p(e)+p.rangeBand()/2,t.y=s-u(t.temp)});var b=y.selectAll("line").data(l).enter().append("line").attr("stroke",function(t,e){return d(e)});b.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y});var w=y.selectAll("circle").data(r).enter().append("circle");w.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("fill",function(t,e){return d(e)}).transition().attr("r",circleWidth).delay(function(t,e){return 200*e}).ease("elastic"),w.on("mouseover",function(t){f.transition().style("opacity",.9),f.html(t.temp+"&deg;F").style("left",d3.event.pageX-35+"px").style("top",d3.event.pageY-35+"px"),o=this.style.fill,d3.select(this).transition().style("opacity",.5).style("fill","yellow")}).on("mouseout",function(t){d3.select(this).transition().style("opacity",1).style("fill",o),f.transition().style("opacity",0)}),v(k),k.attr("transform","translate("+i.left+", "+(s+i.top)+")"),k.selectAll("path").style({fill:"none",stroke:"#000"}),k.selectAll("line").style({stroke:"#000"}),m(x),x.attr("transform","translate("+i.left+", "+i.top+")"),x.selectAll("path").style({fill:"none",stroke:"#000"}),x.selectAll("line").style({stroke:"#000"})}})};document.getElementById("city-input").addEventListener("input",function(t){document.getElementById("chart").innerHTML="",formatChart(this.value)});